<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Document AI Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
      background: #f4f6f8;
      margin: 0;
      display: flex;
      justify-content: center;
      height: 100vh;
    }

    .chat-container {
      width: 100%;
      max-width: 480px;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      border-radius: 12px;
      margin: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }

    .chat-header {
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
    }

    .chat-header h1 {
      font-size: 16px;
      margin: 0;
    }

    .chat-header p {
      font-size: 12px;
      color: #6b7280;
      margin: 4px 0 0;
    }

    .doc-panel {
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 12px;
    }

    .doc-panel h3 {
      margin: 0 0 6px 0;
      font-size: 12px;
      font-weight: 600;
    }

    .doc-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .doc-item label {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .remove-doc {
      color: #dc2626;
      cursor: pointer;
      font-size: 11px;
    }

    .upload {
      margin-top: 8px;
    }

    .upload input {
      font-size: 12px;
    }

    .upload-status {
      font-size: 11px;
      margin-top: 4px;
    }

    .chat-messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      background: #f9fafb;
    }

    .message {
      margin-bottom: 14px;
      max-width: 80%;
      padding: 12px 14px;
      border-radius: 14px;
      font-size: 14px;
      line-height: 1.45;
    }

    .user {
      background: #2563eb;
      color: #ffffff;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }

    .bot {
      background: #ffffff;
      color: #111827;
      border: 1px solid #e5e7eb;
      border-bottom-left-radius: 4px;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      margin-bottom: 6px;
    }

    .high { background: #dcfce7; color: #166534; }
    .medium { background: #fef9c3; color: #854d0e; }
    .low { background: #fee2e2; color: #7f1d1d; }

    .sources-toggle {
      font-size: 12px;
      color: #2563eb;
      cursor: pointer;
      margin-top: 6px;
    }

    .sources {
      font-size: 12px;
      margin-top: 6px;
      padding: 8px;
      background: #f1f5f9;
      border-radius: 8px;
      display: none;
    }

    .chat-input {
      display: flex;
      border-top: 1px solid #e5e7eb;
    }

    .chat-input input {
      flex: 1;
      padding: 14px;
      border: none;
      outline: none;
      font-size: 14px;
    }

    .chat-input button {
      padding: 0 18px;
      background: #2563eb;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }

    .loading {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 10px;
    }
  </style>
</head>

<body>
  <div class="chat-container">
    <div class="chat-header">
      <h1>Document AI Assistant</h1>
      <p>Answers questions using selected documents</p>
    </div>

    <div class="doc-panel">
      <h3>Documents in use</h3>
      <div id="documents"></div>

      <div class="upload">
        <input type="file" id="fileInput" accept="application/pdf" />
        <button onclick="uploadFile()">Upload</button>
        <div id="uploadStatus" class="upload-status"></div>
      </div>
    </div>

    <div id="chat" class="chat-messages">
      <div class="loading">Ask questions based on selected documents.</div>
    </div>

    <div class="chat-input">
      <input id="input" placeholder="Type your question…" />
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

<script>
const chat = document.getElementById("chat");
const input = document.getElementById("input");
let activeDocuments = [];

function addUserMessage(text) {
  const msg = document.createElement("div");
  msg.className = "message user";
  msg.innerText = text;
  chat.appendChild(msg);
}

function addBotMessage(answer, confidence, sources) {
  const msg = document.createElement("div");
  msg.className = "message bot";

  const badge = document.createElement("div");
  badge.className = `badge ${confidence}`;
  badge.innerText =
    confidence === "high" ? "High confidence" :
    confidence === "medium" ? "Medium confidence" :
    "Not found";

  msg.appendChild(badge);

  const text = document.createElement("div");
  text.innerText = answer;
  msg.appendChild(text);

  if (sources.length) {
    const toggle = document.createElement("div");
    toggle.className = "sources-toggle";
    toggle.innerText = "View sources";

    const box = document.createElement("div");
    box.className = "sources";
    box.innerHTML = sources.map(
      s => `${s.source.split("/").pop()} (pages: ${s.pages.join(", ")})`
    ).join("<br>");

    toggle.onclick = () => {
      box.style.display = box.style.display === "none" ? "block" : "none";
    };

    msg.appendChild(toggle);
    msg.appendChild(box);
  }

  chat.appendChild(msg);
  chat.scrollTop = chat.scrollHeight;
}

async function sendMessage() {
  const question = input.value.trim();
  if (!question) return;

  addUserMessage(question);
  input.value = "";

  const loading = document.createElement("div");
  loading.className = "loading";
  loading.innerText = "Thinking…";
  chat.appendChild(loading);

  const res = await fetch("http://127.0.0.1:8000/chat", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      query: question,
      document_ids: activeDocuments
    })
  });

  chat.removeChild(loading);
  const data = await res.json();

  const confidence =
    data.sources.length >= 2 ? "high" :
    data.sources.length === 1 ? "medium" : "low";

  addBotMessage(data.answer, confidence, data.sources);
}

async function uploadFile() {
  const fileInput = document.getElementById("fileInput");
  const status = document.getElementById("uploadStatus");

  if (!fileInput.files.length) {
    status.innerText = "Select a PDF file.";
    return;
  }

  const formData = new FormData();
  formData.append("file", fileInput.files[0]);

  status.innerText = "Uploading…";

  const res = await fetch("http://127.0.0.1:8000/upload", {
    method: "POST",
    body: formData
  });

  status.innerText = res.ok ? "Uploaded successfully." : "Upload failed.";
  fileInput.value = "";
  loadDocuments();
}

async function loadDocuments() {
  const res = await fetch("http://127.0.0.1:8000/documents");
  const docs = await res.json();
  activeDocuments = docs.map(d => d.id);

  const container = document.getElementById("documents");
  container.innerHTML = "";

  docs.forEach(doc => {
    const row = document.createElement("div");
    row.className = "doc-item";

    const label = document.createElement("label");
    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.checked = true;

    checkbox.onchange = () => {
      if (checkbox.checked) activeDocuments.push(doc.id);
      else activeDocuments = activeDocuments.filter(id => id !== doc.id);
    };

    label.appendChild(checkbox);
    label.appendChild(document.createTextNode(doc.name));

    const remove = document.createElement("span");
    remove.className = "remove-doc";
    remove.innerText = "Remove";
    remove.onclick = async () => {
      await fetch(`http://127.0.0.1:8000/documents/${doc.id}`, { method: "DELETE" });
      loadDocuments();
    };

    row.appendChild(label);
    row.appendChild(remove);
    container.appendChild(row);
  });
}

input.addEventListener("keypress", e => {
  if (e.key === "Enter") sendMessage();
});

loadDocuments();
</script>
</body>
</html>
